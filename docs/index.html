<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Detection of anomalous space-time clusters using the scan 
    statistics methodology. Focuses on prospective surveillance of data streams, 
    scanning for clusters with ongoing anomalies. Hypothesis testing is made 
    possible by Monte Carlo simulation.">
<title>Space-Time Anomaly Detection using Scan Statistics • scanstatistics</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Space-Time Anomaly Detection using Scan Statistics">
<meta property="og:description" content="Detection of anomalous space-time clusters using the scan 
    statistics methodology. Focuses on prospective surveillance of data streams, 
    scanning for clusters with ongoing anomalies. Hypothesis testing is made 
    possible by Monte Carlo simulation.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">scanstatistics</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="articles/make_data.html">Process data</a>
    <a class="dropdown-item" href="articles/introduction.html">Introduction to scanstatistics</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/promerpr/scanstatistics/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><ul>
<li>
<a href="#scanstatistics">scanstatistics</a>
<ul>
<li><a href="#installing-the-package">Installing the package</a></li>
<li><a href="#what-are-scan-statistics">What are scan statistics?</a></li>
<li>
<a href="#main-functions">Main functions</a>
<ul>
<li><a href="#scan-statistics">Scan statistics</a></li>
<li><a href="#zone-creation">Zone creation</a></li>
<li><a href="#miscellaneous">Miscellaneous</a></li>
</ul>
</li>
<li>
<a href="#example-brain-cancer-in-new-mexico">Example: Brain cancer in New Mexico</a>
<ul>
<li><a href="#a-scan-statistic-for-poisson-data">A scan statistic for Poisson data</a></li>
</ul>
</li>
<li><a href="#concluding-remarks">Concluding remarks</a></li>
</ul>
</li>
<li><a href="#feedback">Feedback</a></li>
<li><a href="#references">References</a></li>
</ul>
<!-- README.md is generated from README.Rmd. Please edit that file --><!-- badges: start -->
<div class="section level1">
<div class="page-header"><h1 id="scanstatistics">scanstatistics<a class="anchor" aria-label="anchor" href="#scanstatistics"></a>
</h1></div>
<p>An R package for space-time anomaly detection using scan statistics.</p>
<div class="section level2">
<h2 id="installing-the-package">Installing the package<a class="anchor" aria-label="anchor" href="#installing-the-package"></a>
</h2>
<p>To install the latest (CRAN) release of this package, type the following:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"scanstatistics"</span><span class="op">)</span></code></pre></div>
<p>To install the development version of this package, type this instead:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/remote-reexports.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"promerpr/scanstatistics"</span>, ref <span class="op">=</span> <span class="st">"develop"</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="what-are-scan-statistics">What are scan statistics?<a class="anchor" aria-label="anchor" href="#what-are-scan-statistics"></a>
</h2>
<p>Scan statistics are used to detect anomalous clusters in spatial or space-time data. The gist of the methodology, at least in this package, is this:</p>
<ol style="list-style-type: decimal">
<li>Monitor one or more data streams at multiple <em>locations</em> over intervals of time.</li>
<li>Form a set of space-time <em>clusters</em>, each consisting of (1) a collection of locations, and (2) an interval of time stretching from the present to some number of time periods in the past.</li>
<li>For each cluster, compute a statistic based on both the observed and the expected responses. Report the clusters with the largest statistics.</li>
</ol>
</div>
<div class="section level2">
<h2 id="main-functions">Main functions<a class="anchor" aria-label="anchor" href="#main-functions"></a>
</h2>
<div class="section level3">
<h3 id="scan-statistics">Scan statistics<a class="anchor" aria-label="anchor" href="#scan-statistics"></a>
</h3>
<ul>
<li>
<strong><code>scan_eb_poisson</code></strong>: computes the expectation-based Poisson scan statistic (Neill 2005).</li>
<li>
<strong><code>scan_pb_poisson</code></strong>: computes the (population-based) space-time scan statistic (Kulldorff 2001).</li>
<li>
<strong><code>scan_eb_negbin</code></strong>: computes the expectation-based negative binomial scan statistic (Tango et al. 2011).</li>
<li>
<strong><code>scan_eb_zip</code></strong>: computes the expectation-based zero-inflated Poisson scan statistic (Allévius &amp; Höhle 2017).</li>
<li>
<strong><code>scan_permutation</code></strong>: computes the space-time permutation scan statistic (Kulldorff et al. 2005).</li>
<li>
<strong><code>scan_bayes_negbin</code></strong>: computes the Bayesian Spatial scan statistic (Neill 2006), extended to a space-time setting.</li>
</ul>
</div>
<div class="section level3">
<h3 id="zone-creation">Zone creation<a class="anchor" aria-label="anchor" href="#zone-creation"></a>
</h3>
<ul>
<li>
<strong><code>knn_zones</code></strong>: Creates a set of spatial <em>zones</em> (groups of locations) to scan for anomalies. Input is a matrix in which rows are the enumerated locations, and columns the k nearest neighbors. To create such a matrix, the following two functions are useful:
<ul>
<li>
<strong><code>coords_to_knn</code></strong>: use <code><a href="https://rdrr.io/r/stats/dist.html" class="external-link">stats::dist</a></code> to get the k nearest neighbors of each location into a format usable by <code>knn_zones</code>.</li>
<li>
<strong><code>dist_to_knn</code></strong>: use an already computed distance matrix to get the k nearest neighbors of each location into a format usable by <code>knn_zones</code>.</li>
</ul>
</li>
<li>
<strong><code>flexible_zones</code></strong>: An alternative to <code>knn_zones</code> that uses the adjacency structure of locations to create a richer set of zones. The additional input is an adjacency matrix, but otherwise works as <code>knn_zones</code>.</li>
</ul>
</div>
<div class="section level3">
<h3 id="miscellaneous">Miscellaneous<a class="anchor" aria-label="anchor" href="#miscellaneous"></a>
</h3>
<ul>
<li>
<strong><code>score_locations</code></strong>: Score each location by how likely it is to have an ongoing anomaly in it. This score is heuristically motivated.</li>
<li>
<strong><code>top_clusters</code></strong>: Get the top k space-time clusters, either overlapping or non-overlapping in the spatial dimension.</li>
<li>
<strong><code>df_to_matrix</code></strong>: Convert a data frame with data for each location and time point to a matrix with locations along the column dimension and time along the row dimension, with the selected data as values.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="example-brain-cancer-in-new-mexico">Example: Brain cancer in New Mexico<a class="anchor" aria-label="anchor" href="#example-brain-cancer-in-new-mexico"></a>
</h2>
<p>To demonstrate the scan statistics in this package, we will use a dataset of the annual number of brain cancer cases in the counties of New Mexico, for the years 1973-1991. This data was studied by Kulldorff (1998), who detected a cluster of cancer cases in the counties Los Alamos and Santa Fe during the years 1986-1989, though the excess of brain cancer in this cluster was not deemed statistically significant. The data originally comes from the package <em>rsatscan</em>, which provides an interface to the program <a href="http://www.satscan.org" class="external-link">SaTScan</a>, but it has been aggregated and extended for the <em>scanstatistics</em> package.</p>
<p>To get familiar with the counties of New Mexico, we begin by plotting them on a map using the data frames <code>NM_map</code> and <code>NM_geo</code> supplied by the <em>scanstatistics</em> package:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/BenjaK/scanstatistics" class="external-link">scanstatistics</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="co">#&gt; Registered S3 method overwritten by 'ggplot2':</span>
<span class="co">#&gt;   method        from</span>
<span class="co">#&gt;   print.element sets</span>

<span class="co"># Load map data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">NM_map</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">NM_geo</span><span class="op">)</span>

<span class="co"># Plot map with labels at centroids</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_polygon.html" class="external-link">geom_polygon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">NM_map</span>,
               mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span>, group <span class="op">=</span> <span class="va">group</span><span class="op">)</span>,
               color <span class="op">=</span> <span class="st">"grey"</span>, fill <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">NM_geo</span>, 
            mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">center_long</span>, y <span class="op">=</span> <span class="va">center_lat</span>, label <span class="op">=</span> <span class="va">county</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Counties of New Mexico"</span><span class="op">)</span></code></pre></div>
<p><img src="inst/image/newmexico_map-1.png"><!-- --></p>
<p>We can further obtain the yearly number of cases and the population for each country for the years 1973-1991 from the data table <code>NM_popcas</code> provided by the package:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">NM_popcas</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">NM_popcas</span><span class="op">)</span>
<span class="co">#&gt;   year     county population count</span>
<span class="co">#&gt; 1 1973 bernalillo     353813    16</span>
<span class="co">#&gt; 2 1974 bernalillo     357520    16</span>
<span class="co">#&gt; 3 1975 bernalillo     368166    16</span>
<span class="co">#&gt; 4 1976 bernalillo     378483    16</span>
<span class="co">#&gt; 5 1977 bernalillo     388471    15</span>
<span class="co">#&gt; 6 1978 bernalillo     398130    18</span></code></pre></div>
<p>It should be noted that Cibola county was split from Valencia county in 1981, and cases in Cibola have been counted to Valencia in the data.</p>
<div class="section level3">
<h3 id="a-scan-statistic-for-poisson-data">A scan statistic for Poisson data<a class="anchor" aria-label="anchor" href="#a-scan-statistic-for-poisson-data"></a>
</h3>
<p>The Poisson distribution is a natural first option when dealing with count data. The <em>scanstatistics</em> package provides the two functions <code>scan_eb_poisson</code> and <code>scan_pb_poisson</code> with this distributional assumption. The first is an expectation-based[1] scan statistic for univariate Poisson-distributed data proposed by Neill et al. (2005), and we focus on this one in the example below. The second scan statistic is the population-based scan statistic proposed by Kulldorff (2001).</p>
<div class="section level4">
<h4 id="using-the-poisson-scan-statistic">Using the Poisson scan statistic<a class="anchor" aria-label="anchor" href="#using-the-poisson-scan-statistic"></a>
</h4>
<p>The first argument to any of the scan statistics in this package should be a matrix (or array) of observed counts, whether they be integer counts or real-valued “counts”. In such a matrix, the columns should represent locations and the rows the time intervals, ordered chronologically from the earliest interval in the first row to the most recent in the last. In this example we would like to detect a potential cluster of brain cancer in the counties of New Mexico during the years 1986-1989, so we begin by retrieving the count and population data from that period and reshaping them to a matrix using the helper function <code>df_to_matrix</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">NM_popcas</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">1986</span> <span class="op">&amp;</span> <span class="va">year</span> <span class="op">&lt;</span> <span class="fl">1990</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="reference/df_to_matrix.html">df_to_matrix</a></span><span class="op">(</span>time_col <span class="op">=</span> <span class="st">"year"</span>, location_col <span class="op">=</span> <span class="st">"county"</span>, value_col <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="spatial-zones">Spatial zones<a class="anchor" aria-label="anchor" href="#spatial-zones"></a>
</h4>
<p>The second argument to <code>scan_eb_poisson</code> should be a list of integer vectors, each such vector being a <em>zone</em>, which is the name for the spatial component of a potential outbreak cluster. Such a zone consists of one or more locations grouped together according to their similarity across features, and each location is numbered as the corresponding column index of the <code>counts</code> matrix above (indexing starts at 1).</p>
<p>In this example, the locations are the counties of New Mexico and the features are the coordinates of the county seats. These are made available in the data table <code>NM_geo</code>. Similarity will be measured using the geographical distance between the seats of the counties, taking into account the curvature of the earth. A distance matrix is calculated using the <code>spDists</code> function from the <em>sp</em> package, which is then passed to <code>dist_to_knn</code> and on to <code>knn_zones</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/sp/" class="external-link">sp</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span>

<span class="co"># Remove Cibola since cases have been counted towards Valencia. Ideally, this</span>
<span class="co"># should be accounted for when creating the zones.</span>
<span class="va">zones</span> <span class="op">&lt;-</span> <span class="va">NM_geo</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">county</span> <span class="op">!=</span> <span class="st">"cibola"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">seat_long</span>, <span class="va">seat_lat</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="va">as.matrix</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/sp/man/spDistsN1.html" class="external-link">spDists</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.</span>, y <span class="op">=</span> <span class="va">.</span>, longlat <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="reference/dist_to_knn.html">dist_to_knn</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="va">knn_zones</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="baselines">Baselines<a class="anchor" aria-label="anchor" href="#baselines"></a>
</h4>
<p>The advantage of expectation-based scan statistics is that parameters such as the expected value can be modelled and estimated from past data e.g. by some form of regression. For the expectation-based Poisson scan statistic, we can use a (very simple) Poisson GLM to estimate the expected value of the count in each county and year, accounting for the different populations in each region. Similar to the <code>counts</code> argument, the expected values should be passed as a matrix to the <code>scan_eb_poisson</code> function:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">population</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">year</span> <span class="op">-</span> <span class="fl">1985</span><span class="op">)</span>,
           family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,
           data <span class="op">=</span> <span class="va">NM_popcas</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">&lt;</span> <span class="fl">1986</span><span class="op">)</span><span class="op">)</span>

<span class="va">ebp_baselines</span> <span class="op">&lt;-</span> <span class="va">NM_popcas</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">1986</span> <span class="op">&amp;</span> <span class="va">year</span> <span class="op">&lt;</span> <span class="fl">1990</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="va">.</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="reference/df_to_matrix.html">df_to_matrix</a></span><span class="op">(</span>value_col <span class="op">=</span> <span class="st">"mu"</span><span class="op">)</span></code></pre></div>
<p>Note that the population numbers are (perhaps poorly) interpolated from the censuses conducted in 1973, 1982, and 1991.</p>
</div>
<div class="section level4">
<h4 id="calculation">Calculation<a class="anchor" aria-label="anchor" href="#calculation"></a>
</h4>
<p>We can now calculate the Poisson scan statistic. To give us more confidence in our detection results, we will perform 999 Monte Carlo replications, by which data is generated using the parameters from the null hypothesis and a new scan statistic calculated. This is then summarized in a P-value, calculated as the proportion of times the replicated scan statistics exceeded the observed one. The output of <code>scan_poisson</code> is an object of class “scanstatistic”, which comes with the print method seen below.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">poisson_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/scan_eb_poisson.html">scan_eb_poisson</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">counts</span>, 
                                  zones <span class="op">=</span> <span class="va">zones</span>, 
                                  baselines <span class="op">=</span> <span class="va">ebp_baselines</span>,
                                  n_mcsim <span class="op">=</span> <span class="fl">999</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">poisson_result</span><span class="op">)</span>
<span class="co">#&gt; Data distribution:                Poisson</span>
<span class="co">#&gt; Type of scan statistic:           expectation-based</span>
<span class="co">#&gt; Setting:                          univariate</span>
<span class="co">#&gt; Number of locations considered:   32</span>
<span class="co">#&gt; Maximum duration considered:      4</span>
<span class="co">#&gt; Number of spatial zones:          415</span>
<span class="co">#&gt; Number of Monte Carlo replicates: 999</span>
<span class="co">#&gt; Monte Carlo P-value:              0.005</span>
<span class="co">#&gt; Gumbel P-value:                   NULL</span>
<span class="co">#&gt; Most likely event duration:       4</span>
<span class="co">#&gt; ID of locations in MLC:           15, 26</span></code></pre></div>
<p>As we can see, the most likely cluster for an anomaly stretches from 1986-1989 and involves the locations numbered 15 and 26, which correspond to the counties</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>counties <span class="ot">&lt;-</span> <span class="fu">as.character</span>(NM_geo<span class="sc">$</span>county)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>counties[<span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">26</span>)]</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"losalamos"</span> <span class="st">"santafe"</span>  </span></code></pre></div>
<p>These are the same counties detected by Kulldorff (1998), though their analysis was retrospective rather than prospective as ours was. Ours was also data dredging as we used the same study period with hopes of detecting the same cluster.</p>
</div>
<div class="section level4">
<h4 id="a-heuristic-score-for-locations">A heuristic score for locations<a class="anchor" aria-label="anchor" href="#a-heuristic-score-for-locations"></a>
</h4>
<p>We can score each county according to how likely it is to be part of a cluster in a heuristic fashion using the function <code>score_locations</code>, and visualize the results on a heatmap as follows:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Calculate scores and add column with county names</span>
<span class="va">county_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/score_locations.html">score_locations</a></span><span class="op">(</span><span class="va">poisson_result</span>, <span class="va">zones</span><span class="op">)</span>
<span class="va">county_scores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>county <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">counties</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">counties</span><span class="op">)</span><span class="op">]</span>, 
                                          levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">NM_geo</span><span class="op">$</span><span class="va">county</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Create a table for plotting</span>
<span class="va">score_map_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">NM_map</span>, <span class="va">county_scores</span>, by <span class="op">=</span> <span class="st">"county"</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">group</span>, <span class="va">order</span><span class="op">)</span>

<span class="co"># As noted before, Cibola county counts have been attributed to Valencia county</span>
<span class="va">score_map_df</span><span class="op">[</span><span class="va">score_map_df</span><span class="op">$</span><span class="va">subregion</span> <span class="op">==</span> <span class="st">"cibola"</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>relative_score <span class="op">=</span> <span class="va">score_map_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
                          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">subregion</span> <span class="op">==</span> <span class="st">"valencia"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
                          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">relative_score</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
                          <span class="va">.</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_polygon.html" class="external-link">geom_polygon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">score_map_df</span>,
               mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span>, group <span class="op">=</span> <span class="va">group</span>, 
                             fill <span class="op">=</span> <span class="va">relative_score</span><span class="op">)</span>,
               color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"#e5f5f9"</span>, high <span class="op">=</span> <span class="st">"darkgreen"</span>,
                      guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Relative\nScore"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">NM_geo</span>, 
            mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">center_long</span>, y <span class="op">=</span> <span class="va">center_lat</span>, label <span class="op">=</span> <span class="va">county</span><span class="op">)</span>,
            alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"County scores"</span><span class="op">)</span></code></pre></div>
<p><img src="inst/image/county_scores-1.png"><!-- --></p>
<p>A warning though: the <code>score_locations</code> function can be quite slow for large data sets. This might change in future versions of the package.</p>
</div>
<div class="section level4">
<h4 id="finding-the-top-scoring-clusters">Finding the top-scoring clusters<a class="anchor" aria-label="anchor" href="#finding-the-top-scoring-clusters"></a>
</h4>
<p>Finally, if we want to know not just the most likely cluster, but say the five top-scoring space-time clusters, we can use the function <code>top_clusters</code>. The clusters returned can either be overlapping or non-overlapping in the spatial dimension, according to our liking.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">top5</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/top_clusters.html">top_clusters</a></span><span class="op">(</span><span class="va">poisson_result</span>, <span class="va">zones</span>, k <span class="op">=</span> <span class="fl">5</span>, overlapping <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># Find the counties corresponding to the spatial zones of the 5 clusters.</span>
<span class="va">top5_counties</span> <span class="op">&lt;-</span> <span class="va">top5</span><span class="op">$</span><span class="va">zone</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">get_zone</span>, zones <span class="op">=</span> <span class="va">zones</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">counties</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span>

<span class="co"># Add the counties corresponding to the zones as a column</span>
<span class="va">top5</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>counties <span class="op">=</span> <span class="va">top5_counties</span><span class="op">)</span></code></pre></div>
<p>The <code>top_clusters</code> function includes Monte Carlo and Gumbel P-values for each cluster. These P-values are conservative, since secondary clusters from the original data are compared to the most likely clusters from the replicate data sets.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="concluding-remarks">Concluding remarks<a class="anchor" aria-label="anchor" href="#concluding-remarks"></a>
</h2>
<p>Other univariate scan statistics can be calculated practically in the same way as above, though the distribution parameters need to be adapted for each scan statistic.</p>
</div>
</div>
<div class="section level1">
<h1 id="feedback">Feedback<a class="anchor" aria-label="anchor" href="#feedback"></a>
</h1>
<p>If you think this package lacks some functionality, or that something needs better documentation, please open an issue here. I’m also very interested in applying the methods in this package (current and future) to new problems, so if you know of any suitable public datasets, please tell me! A dataset with a multivariate response (e.g. multiple counter variables) would be of particular interest.</p>
</div>
<div class="section level1">
<h1 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h1>
<p>Allévius, B., M. Höhle (2017): <em>An expectation-based space-time scan statistic for ZIP-distributed data</em>, (under review).</p>
<p>Kleinman, K. (2015): <em>Rsatscan: Tools, Classes, and Methods for Interfacing with SaTScan Stand-Alone Software</em>, <a href="https://CRAN.R-project.org/package=rsatscan" class="external-link uri">https://CRAN.R-project.org/package=rsatscan</a>.</p>
<p>Kulldorff, M., Athas, W. F., Feuer, E. J., Miller, B. A., Key, C. R. (1998): <em>Evaluating Cluster Alarms: A Space-Time Scan Statistic and Brain Cancer in Los Alamos</em>, American Journal of Public Health 88 (9), 1377–80.</p>
<p>Kulldorff, M. (2001), <em>Prospective time periodic geographical disease surveillance using a scan statistic</em>, Journal of the Royal Statistical Society, Series A (Statistics in Society), 164, 61–72.</p>
<p>Kulldorff, M., Heffernan, R., Hartman, J., Assunção, R. M., Mostashari, F. (2005): <em>A space-time permutation scan statistic for disease outbreak detection</em>, PLoS Medicine, 2 (3), 0216-0224.</p>
<p>Neill, D. B., Moore, A. W., Sabhnani, M., Daniel, K. (2005): <em>Detection of Emerging Space-Time Clusters</em>, In Proceedings of the Eleventh ACM SIGKDD International Conference on Knowledge Discovery in Data Mining, 218–27. ACM.</p>
<p>Neill, D. B., Moore, A. W., Cooper, G. F. (2006): <em>A Bayesian Spatial Scan Statistic</em>, Advances in Neural Information Processing Systems 18: Proceedings of the 2005 Conference.</p>
<p>Tango, T., Takahashi, K. Kohriyama, K. (2011), <em>A Space-Time Scan Statistic for Detecting Emerging Outbreaks</em>, Biometrics 67 (1), 106–15.</p>
<p>[1] Expectation-based scan statistics use past non-anomalous data to estimate distribution parameters, and then compares observed cluster counts from the time period of interest to these estimates. In contrast, <em>population-based</em> scan statistics compare counts in a cluster to those outside, only using data from the period of interest, and does so conditional on the observed total count.</p>
</div>

  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=scanstatistics" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/promerpr/scanstatistics/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/promerpr/scanstatistics/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small>GPL (&gt;= 3)</small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing scanstatistics</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Benjamin Allévius <br><small class="roles"> Author </small>  </li>
<li>Paul Romer Present <br><small class="roles"> Contributor, maintainer </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/promerpr/scanstatistics/actions" class="external-link"><img src="https://github.com/promerpr/scanstatistics/workflows/R-CMD-check/badge.svg" alt="R-CMD-check"></a></li>
<li><a href="https://cran.r-project.org/package=scanstatistics" class="external-link"><img src="http://www.r-pkg.org/badges/version/scanstatistics" alt="CRAN_Status_Badge"></a></li>
<li><a href="http://cran.rstudio.com/web/packages/scanstatistics/index.html" class="external-link"><img src="https://cranlogs.r-pkg.org/badges/grand-total/scanstatistics" alt="CRAN downloads"></a></li>
<li><a href="https://doi.org/10.21105/joss.00515" class="external-link"><img src="http://joss.theoj.org/papers/10.21105/joss.00515/status.svg" alt="DOI"></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Benjamin Allévius, Paul Romer Present.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
